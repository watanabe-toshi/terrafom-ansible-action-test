#!/bin/bash
set -euo pipefail

PROXY_HOST="${proxy_ip}"
PROXY_PORT="3128"
PROXY_URL="http://${PROXY_HOST}:${PROXY_PORT}"
NO_PROXY_LIST="169.254.169.254,127.0.0.1,localhost"

# dnf にプロキシ設定
CONF="/etc/dnf/dnf.conf"
touch "$CONF"
if ! grep -q '^proxy=' "$CONF"; then
  echo "proxy=${PROXY_URL}" >> "$CONF"
else
  sed -i "s|^proxy=.*$|proxy=${PROXY_URL}|" "$CONF"
fi

# 環境変数（他ツール用）
cat >/etc/profile.d/proxy.sh <<EOF
export http_proxy=${PROXY_URL}
export https_proxy=${PROXY_URL}
export no_proxy=${NO_PROXY_LIST}
export HTTP_PROXY=${PROXY_URL}
export HTTPS_PROXY=${PROXY_URL}
export NO_PROXY=${NO_PROXY_LIST}
EOF
chmod 644 /etc/profile.d/proxy.sh

dnf -y clean all || true
